/*APERFEIÇOANDO A CLAUSULA GROUP BY. TRABALHANDO 
HAVING E COM OPERAÇÕES CHAMADAS DE ROLLUP E CUBE*/ 

SELECT COD_ALUNO, TRUNC(DATA),
       SUM(DESCONTO) DESCONTO,
       SUM(TOTAL)TOTAL 
FROM   TCONTRATO
GROUP  BY ROLLUP(COD_ALUNO, TRUNC(DATA)); --ROLLUP TRÁS UM SUBTOTAL POR CADA GRUPO, ELEMENTO DE TABELA



--EXECUTANDO MESMO PROCEDIMENTO ACIMA PORÉM DE FORMA MAIS ORGANIZADA E DETALHADA
--QUANDO DATA FOR NULO E COD_ALUNO NÃO, MOSTRE SUB-TOTAL
--QUANDO DATA E COD_ALUNO FOREM NULOS, MOSTRE TOTAL GERAL
SELECT COD_ALUNO,
       CASE
         WHEN TRUNC(DATA) IS NULL AND COD_ALUNO IS NOT NULL THEN 'SUB-TOTAL'
         WHEN COD_ALUNO IS NULL THEN 'TOTAL GERAL'
         ELSE TO_CHAR(TRUNC(DATA))
       END DESCRICAO,
       ROUND(AVG(DESCONTO),2) DESCONTO,
       SUM(TOTAL) TOTAL
FROM   TCONTRATO
GROUP  BY ROLLUP(COD_ALUNO, TRUNC(DATA));



--TRABALHANDO COM GROUP BY CUBE


SELECT COD_ALUNO,
       TRUNC(DATA),
       SUM(TOTAL)
FROM TCONTRATO
GROUP BY CUBE(COD_ALUNO, TRUNC(DATA));


SELECT * FROM TCONTRATO;

--GROUPING -> FUNÇÃO QUE IDENTIFICA TOTAL GERAL
SELECT GROUPING(COD_ALUNO), 
       SUM(TOTAL)
FROM TCONTRATO
GROUP BY ROLLUP(COD_ALUNO);


--EXECUTANDO O PROCESSO ACIMA DE FORMA MAIS DETALHADA
SELECT GROUPING(COD_ALUNO),
       CASE
         WHEN GROUPING(COD_ALUNO)=0 THEN TO_CHAR(COD_ALUNO)
         ELSE 'TOTAL GERAL: '
       END ALUNO,
       SUM(TOTAL)
FROM TCONTRATO
GROUP BY ROLLUP(COD_ALUNO);


--GROUPING ID -> IDENTIFICA SUBTOTAL
SELECT TRUNC(DATA),
       GROUPING_ID(TRUNC(DATA)) GDT,
       COD_ALUNO,
       GROUPING_ID(COD_ALUNO) GCL,
       SUM(TOTAL)
FROM TCONTRATO
GROUP BY ROLLUP(TRUNC(DATA), COD_ALUNO);



--DETALHANDO O PROCESSO. PARTINDO DO PRINCIPIO BOOLEANO 
SELECT TRUNC(DATA), COD_ALUNO,
       CASE
         WHEN GROUPING_ID(COD_ALUNO)= 1 AND
           GROUPING_ID(TRUNC(DATA)) = 0 THEN 'TOTAL DO DIA: '
         WHEN GROUPING_ID(COD_ALUNO)= 1 AND
           GROUPING_ID(TRUNC(DATA)) = 1 THEN 'TOTAL GERAL : '
       END AS DESCRICAO,
       SUM(TOTAL) TOTAL
FROM TCONTRATO
GROUP BY ROLLUP(TRUNC(DATA), COD_ALUNO);

