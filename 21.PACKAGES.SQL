/*DESENVOLVENDO PACKAGES DE BANCO DE DADOS PARA AGRUPAR OBJETOS PL/SQL (IDENTIFICADORES E ROTINAS)

FAZEM PARTE DA CONSTRUÇÃO DE PACKAGES:
 *VARIAVEIS
 *CURSORES
 *CONSTANTES
 *EXCEÇÕES
 *PROCEDIMENTOS
 *FUNÇÕES*/

/*CONSTRUÇÕES PUBLICAS EM UMA PACKAGE SÃO AS QUE PODEM SER INVOCADAS POR 
PROCEDIMENTOS OU FUNÇÕES EXTERNAS À PACKAGE. JÁ AS PRIVADAS SÃO AS QUE
NÃO PODEM SER INVOCADAS POR FUNÇÕES OU PROCEDIMENTOS EXTERNOS.*/
 


--CRIANDO A ESPECIFICAÇÃO DO PACOTE
CREATE OR REPLACE PACKAGE PKG_ALUNO
IS
  VCIDADE VARCHAR2(30);   --VARIÁVEIS PÚBLICAS
  VMEDIA NUMBER(8,2);     --VARIÁVEIS PÚBLICAS
  VNOME VARCHAR2(30);     --VARIÁVEIS PÚBLICAS 
  PROCEDURE DELETA_ALUNO(PCOD_ALUNO NUMBER); 
  PROCEDURE MEDIA_CONTRATOS;
  PROCEDURE CON_ALUNO(PCOD_ALUNO NUMBER);
END;


/*CRIANDO O CORPO, ONDE SERÃO FEITAS AS FUNÇÕES
  AS PROCEDURES DO BODY INTERAGEM ENTRE SI*/
CREATE OR REPLACE PACKAGE BODY PKG_ALUNO
IS
    
  VTESTE VARCHAR(20);

--------------------------------------------------------  
  
  PROCEDURE MEDIA_CONTRATOS /*ENVIANDO MEDIA PARA APENAS UMA VARIAVEL. NO CASO, VMEDIA.
                            PODE SER ACESSADA PELA PROCEDURE OU POR VMEIA*/
  IS
  BEGIN
    VTESTE :='TESTE';
    SELECT AVG(TOTAL) INTO VMEDIA FROM TCONTRATO;
  END;


--------------------------------------------------------
 
                                                  
  PROCEDURE CON_ALUNO(PCOD_ALUNO NUMBER)  /*ENVIANDO PROCEDURE PARA CONSULTAR ALUNO (CONSULTANDO APENAS O NOME)*/
  IS
  BEGIN
    VNOME:='';
    SELECT NOME INTO VNOME FROM TALUNO
    WHERE COD_ALUNO=PCOD_ALUNO;
  EXCEPTION                               /*CRIANDO EXCEPTION PARA QUE O PROGRAMA CONTINUE CASO ALUNO NAO EXISTA*/
    WHEN NO_DATA_FOUND THEN
      DBMS_OUTPUT.PUT_LINE('ALUNO NÃO EXISTE');
  END;
  

---------------------------------------------------------

  PROCEDURE DELETA_ALUNO(PCOD_ALUNO NUMBER) 
  IS
  BEGIN
    CON_ALUNO(PCOD_ALUNO);
    IF LENGTH(VNOME) > 0 THEN             /*CASO ALUNO NÃO EXISTA, O PROGRAMA NÃO EXECUTARÁ O DELETE DENTRO DO IF*/
      DELETE FROM TALUNO WHERE COD_ALUNO = PCOD_ALUNO;
      DBMS_OUTPUT.PUT_LINE(VNOME||'--> EXCLUIDO');
    END IF;
  END;
END;   



/*USANDO A PACKAGE (SÓ É POSSIVEL EXECUTA-LA FORA 
DA PACKAGE POIS SE TRATA DE UMA PROCEDURE PUBLICA)*/
BEGIN
  PKG_ALUNO.DELETA_ALUNO(60);
END; 

SELECT * FROM TALUNO;


--UTILIZANDO BLOCO ANONIMO PARA EXECUTAR MEDIA CONTRATO
DECLARE
  M NUMBER;
BEGIN
  PKG_ALUNO.MEDIA_CONTRATOS; --EXECUTA PROCEDURE
  M := PKG_ALUNO.VMEDIA;
  DBMS_OUTPUT.PUT_LINE('MEDIA: '||M);
END; 

 
--BUSCANDO ALUNO PELO COD_ALUNO UTILIZANDO PROCEDURE NO PACKAGE
DECLARE
  NOME VARCHAR(30);
BEGIN
  PKG_ALUNO.CON_ALUNO(1);   --EXECUTA PROCEDURE
  NOME := PKG_ALUNO.VNOME;
  DBMS_OUTPUT.PUT_LINE('NOME '||NOME);
END;
  


--MESMO PROCESSO ACIMA, PORÉM DE FORMA SIMPLIFICADA
BEGIN
  PKG_ALUNO.CON_ALUNO(3);    --EXECUTA PROCEDURE
  DBMS_OUTPUT.PUT_LINE('NOME '||PKG_ALUNO.VNOME);
END;
